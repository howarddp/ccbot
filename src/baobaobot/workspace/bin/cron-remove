#!/usr/bin/env python3
"""Remove a cron job from the workspace.

Usage:
    cron-remove <job_id> [--workspace PATH]

Examples:
    cron-remove a1b2c3d4
"""

import argparse
import json
import os
import sys
import tempfile
from pathlib import Path


def resolve_workspace():
    """Find workspace dir: cwd or parent with cron/ or memory/ dir."""
    cwd = Path.cwd()
    for d in [cwd, *cwd.parents]:
        if (d / "cron").is_dir() or (d / "memory").is_dir() or (d / "MEMORY.md").is_file():
            return d
    print(
        "Cannot determine workspace. Use --workspace or run from a workspace dir.",
        file=sys.stderr,
    )
    sys.exit(1)


def atomic_write_json(path, data, indent=2):
    """Write JSON atomically via temp file + rename."""
    path.parent.mkdir(parents=True, exist_ok=True)
    content = json.dumps(data, indent=indent, ensure_ascii=False)
    fd, tmp_path = tempfile.mkstemp(
        dir=str(path.parent), suffix=".tmp", prefix=f".{path.name}."
    )
    try:
        with os.fdopen(fd, "w", encoding="utf-8") as f:
            f.write(content)
            f.write("\n")
            f.flush()
            os.fsync(f.fileno())
        os.replace(tmp_path, str(path))
    except BaseException:
        try:
            os.unlink(tmp_path)
        except OSError:
            pass
        raise


def main():
    parser = argparse.ArgumentParser(description="Remove a cron job")
    parser.add_argument("job_id", help="Job ID to remove")
    parser.add_argument("--workspace", default=None, help="Workspace path")
    args = parser.parse_args()

    workspace = Path(args.workspace) if args.workspace else resolve_workspace()
    if not workspace.exists():
        print(f"Workspace not found: {workspace}", file=sys.stderr)
        sys.exit(1)

    path = workspace / "cron" / "jobs.json"
    if not path.is_file():
        print(f"No cron jobs found (jobs.json does not exist).", file=sys.stderr)
        sys.exit(1)

    try:
        data = json.loads(path.read_text(encoding="utf-8"))
    except (json.JSONDecodeError, OSError) as e:
        print(f"Error reading jobs.json: {e}", file=sys.stderr)
        sys.exit(1)

    jobs = data.get("jobs", [])
    original_count = len(jobs)
    data["jobs"] = [j for j in jobs if j.get("id") != args.job_id]

    if len(data["jobs"]) == original_count:
        print(f"Job not found: {args.job_id}", file=sys.stderr)
        sys.exit(1)

    atomic_write_json(path, data)
    print(f"âœ… Job removed: {args.job_id}")


if __name__ == "__main__":
    main()
