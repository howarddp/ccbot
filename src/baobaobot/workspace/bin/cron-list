#!/usr/bin/env python3
"""List cron jobs in the workspace.

Usage:
    cron-list [--json] [--workspace PATH]

Examples:
    cron-list
    cron-list --json
"""

import argparse
import json
import sys

from _cron_common import cols_to_schedule, connect_db, format_schedule, format_ts, resolve_workspace


def main():
    parser = argparse.ArgumentParser(description="List cron jobs")
    parser.add_argument("--json", action="store_true", dest="as_json", help="Output as JSON")
    parser.add_argument("--workspace", default=None, help="Workspace path")
    args = parser.parse_args()

    workspace = resolve_workspace(args.workspace)
    if not workspace.exists():
        print(f"Workspace not found: {workspace}", file=sys.stderr)
        sys.exit(1)

    conn = connect_db(workspace)
    try:
        rows = conn.execute(
            "SELECT * FROM cron_jobs ORDER BY created_at"
        ).fetchall()
    finally:
        conn.close()

    if args.as_json:
        jobs = []
        for row in rows:
            jobs.append({
                "id": row["id"],
                "name": row["name"],
                "schedule": cols_to_schedule(row),
                "message": row["message"],
                "enabled": bool(row["enabled"]),
                "delete_after_run": bool(row["delete_after_run"]),
                "system": bool(row["system"]),
                "creator_user_id": row["creator_user_id"],
                "created_at": row["created_at"],
                "updated_at": row["updated_at"],
                "state": {
                    "next_run_at": row["next_run_at"],
                    "running_at": row["running_at"],
                    "last_run_at": row["last_run_at"],
                    "last_status": row["last_status"],
                    "last_error": row["last_error"],
                    "last_duration_s": row["last_duration_s"],
                    "consecutive_errors": row["consecutive_errors"],
                    "last_summary_offset": row["last_summary_offset"],
                    "last_summary_jsonl": row["last_summary_jsonl"],
                },
            })
        print(json.dumps(jobs, indent=2, ensure_ascii=False))
        sys.exit(0)

    if not rows:
        print("No cron jobs found.")
        sys.exit(0)

    print(f"üìã Cron jobs ({len(rows)}):\n")
    for row in rows:
        job_id = row["id"]
        name = row["name"]
        enabled = row["enabled"]
        next_run = row["next_run_at"]
        delete_flag = " [one-shot]" if row["delete_after_run"] else ""
        status_icon = "üü¢" if enabled else "‚è∏Ô∏è"

        print(f"  {status_icon} [{job_id}] {name}{delete_flag}")
        print(f"     Schedule: {format_schedule(row)}")
        print(f"     Message:  {row['message']}")
        print(f"     Next run: {format_ts(next_run)}")
        print()


if __name__ == "__main__":
    main()
