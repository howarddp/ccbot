#!/usr/bin/env bash
# Load environment variables from baobaobot .env file.
# Usage: source "{{BIN_DIR}}/_load_env"  (in SKILL.md)
#        source "$(dirname "$0")/_load_env"  (in bin scripts)
#
# Resolution order for .env location:
#   1. $BAOBAOBOT_DIR/.env
#   2. ~/.config/baobaobot/dir (pointer file) -> $DIR/.env
#   3. ~/.baobaobot/.env

_baobaobot_load_env() {
    local config_dir=""

    # 1. BAOBAOBOT_DIR env var
    if [ -n "$BAOBAOBOT_DIR" ]; then
        config_dir="$BAOBAOBOT_DIR"
    fi

    # 2. Pointer file
    if [ -z "$config_dir" ] && [ -f "$HOME/.config/baobaobot/dir" ]; then
        config_dir="$(cat "$HOME/.config/baobaobot/dir")"
    fi

    # 3. Default
    if [ -z "$config_dir" ]; then
        config_dir="$HOME/.baobaobot"
    fi

    local env_file="$config_dir/.env"
    if [ ! -f "$env_file" ]; then
        return 1
    fi

    # Export each KEY=VALUE line (skip comments and blank lines)
    # Compatible with both bash and zsh
    while IFS= read -r line || [ -n "$line" ]; do
        # Skip empty lines and comments
        case "$line" in
            ""|\#*|\ *\#*) continue ;;
        esac
        # Only process lines with =
        case "$line" in
            *=*) ;;
            *) continue ;;
        esac
        local key="${line%%=*}"
        local val="${line#*=}"
        # Don't override existing env vars
        eval "local existing=\${$key:-}"
        if [ -z "$existing" ]; then
            export "$key=$val"
        fi
    done < "$env_file"
}

_baobaobot_load_runtime() {
    # Load runtime env vars (e.g. SHARE_PUBLIC_URL set dynamically by bot)
    local config_dir=""
    if [ -n "$BAOBAOBOT_DIR" ]; then
        config_dir="$BAOBAOBOT_DIR"
    elif [ -f "$HOME/.config/baobaobot/dir" ]; then
        config_dir="$(cat "$HOME/.config/baobaobot/dir")"
    else
        config_dir="$HOME/.baobaobot"
    fi

    local runtime_file="$config_dir/.runtime_env"
    if [ ! -f "$runtime_file" ]; then
        return 0
    fi

    while IFS= read -r line || [ -n "$line" ]; do
        case "$line" in
            ""|\#*|\ *\#*) continue ;;
        esac
        case "$line" in
            *=*) ;;
            *) continue ;;
        esac
        local key="${line%%=*}"
        local val="${line#*=}"
        # Runtime vars always override (they're dynamic)
        export "$key=$val"
    done < "$runtime_file"
}

_baobaobot_load_env
_baobaobot_load_runtime
