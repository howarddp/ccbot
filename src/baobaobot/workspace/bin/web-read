#!/usr/bin/env python3
"""Extract clean text content from a web page.

Uses trafilatura for fast extraction; falls back to Playwright (headless
Chromium) when trafilatura fails (e.g. 403, bot protection, JS-rendered pages).

Usage:
    web-read "URL" [--format markdown|text] [--length N]
"""

from __future__ import annotations

import argparse
import sys


def _fetch_with_playwright(url: str) -> str | None:
    """Fetch page HTML using headless Chromium via Playwright."""
    try:
        from playwright.sync_api import sync_playwright
    except ImportError:
        print("Playwright not installed, skipping browser fallback.", file=sys.stderr)
        return None

    try:
        with sync_playwright() as p:
            browser = p.chromium.launch(headless=True)
            page = browser.new_page()
            page.goto(url, wait_until="domcontentloaded", timeout=30000)
            page.wait_for_timeout(2000)  # let JS render
            html = page.content()
            browser.close()
            return html
    except Exception as e:
        msg = str(e)
        if "Executable doesn't exist" in msg or "browserType.launch" in msg:
            print("Chromium not installed. Run: playwright install chromium", file=sys.stderr)
        else:
            print(f"Playwright fetch error: {e}", file=sys.stderr)
        return None


def main() -> None:
    parser = argparse.ArgumentParser(description="Extract clean text from a web page")
    parser.add_argument("url", help="URL to read")
    parser.add_argument("--format", default="markdown", choices=["markdown", "text", "xml"], dest="out_format", help="Output format (default: markdown)")
    parser.add_argument("--length", type=int, default=0, help="Max output length in chars (0=unlimited)")
    parser.add_argument("--with-metadata", action="store_true", help="Include page metadata (title, author, date)")
    args = parser.parse_args()

    try:
        import trafilatura
    except ImportError:
        print("Error: trafilatura not installed. Run: pip install trafilatura", file=sys.stderr)
        sys.exit(1)

    # Try trafilatura first (fast, lightweight)
    downloaded = None
    try:
        downloaded = trafilatura.fetch_url(args.url)
    except Exception as e:
        print(f"trafilatura fetch error: {e}", file=sys.stderr)

    # Fallback to Playwright if trafilatura fails
    used_playwright = False
    if downloaded is None:
        print("trafilatura failed, trying Playwright...", file=sys.stderr)
        downloaded = _fetch_with_playwright(args.url)
        used_playwright = True

    if downloaded is None:
        print(f"Failed to fetch: {args.url}", file=sys.stderr)
        sys.exit(1)

    output_format = "txt" if args.out_format == "text" else args.out_format
    result = trafilatura.extract(
        downloaded,
        output_format=output_format,
        include_links=True,
        include_images=True,
        include_tables=True,
        with_metadata=args.with_metadata,
    )

    if result is None:
        print("Could not extract content from this page.", file=sys.stderr)
        sys.exit(1)

    if used_playwright:
        print("[fetched via browser]", file=sys.stderr)

    if args.with_metadata:
        metadata = trafilatura.extract_metadata(downloaded)
        if metadata:
            if metadata.title:
                print(f"# {metadata.title}")
            meta_parts = []
            if metadata.author:
                meta_parts.append(f"Author: {metadata.author}")
            if metadata.date:
                meta_parts.append(f"Date: {metadata.date}")
            if metadata.sitename:
                meta_parts.append(f"Site: {metadata.sitename}")
            if meta_parts:
                print(" | ".join(meta_parts))
            print(f"URL: {args.url}")
            print()

    output = result
    if args.length > 0 and len(output) > args.length:
        output = output[:args.length] + "\n\n... [truncated]"

    print(output)


if __name__ == "__main__":
    main()
