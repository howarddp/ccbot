#!/usr/bin/env python3
"""Save text or files to BaoBao's memory.

Supports three modes:
  1. Text to daily memory:     memory-save "learned something"
  2. Text to experience:       memory-save -e topic "long-term info"
  3. File attachment to daily:  memory-save /path/to/file "description"
  4. File attachment to experience: memory-save -e topic /path/to/file "description"

Auto-detection: if the first positional argument is an existing file path,
attachment mode is used (requires a description). Otherwise, text mode is used.

Usage:
    memory-save <text_or_file> [description] [--user NAME] [-e TOPIC]
    memory-save --text "content" [--user NAME] [-e TOPIC]

Examples:
    memory-save "TODO: implement command extension" --user Alice
    memory-save "OpenClaw uses register(api) pattern" -e openclaw-research
    memory-save /path/to/screenshot.png "architecture diagram" --user Alice
    memory-save -e project-notes /path/to/diagram.png "system diagram"
"""

from __future__ import annotations

import argparse
import sys
from datetime import date
from pathlib import Path
from typing import Optional

from _memory_common import (
    append_to_experience_file,
    attachment_ref,
    commit_memory,
    copy_to_attachments,
    ensure_daily_file,
)


def resolve_workspace() -> Path:
    """Resolve workspace directory: --workspace > cwd (if has memory/) > error."""
    cwd = Path.cwd()
    if (cwd / "memory").is_dir() or (cwd / "MEMORY.md").is_file():
        return cwd
    print(
        "Cannot determine workspace. Use --workspace or run from a workspace dir.",
        file=sys.stderr,
    )
    sys.exit(1)


def save_text_daily(workspace: Path, text: str, user_name: Optional[str] = None) -> str:
    """Append text to today's daily memory file.

    Returns the relative path of the daily file.
    """
    today_str = date.today().isoformat()
    path = ensure_daily_file(workspace, today_str)

    tag = f"[{user_name}] " if user_name else ""
    with path.open("a", encoding="utf-8") as f:
        f.write(f"- {tag}{text}\n")

    commit_memory(workspace / "memory", f"daily: append {today_str}")
    year_month = today_str[:7]
    return f"memory/daily/{year_month}/{today_str}.md"


def save_text_experience(
    workspace: Path, topic: str, text: str, user_name: Optional[str] = None
) -> str:
    """Append text to an experience topic file.

    Returns the relative path of the experience file.
    """
    tag = f"[{user_name}] " if user_name else ""
    rel = append_to_experience_file(workspace, topic, f"- {tag}{text}")
    commit_memory(workspace / "memory", f"experience: update {topic}")
    return rel


def save_attachment(
    workspace: Path,
    source: Path,
    description: str,
    user_name: Optional[str] = None,
    topic: Optional[str] = None,
) -> str:
    """Copy file to memory/attachments/ and append reference to daily or experience memory.

    Returns the relative path of the saved attachment.
    """
    rel_path, _ = copy_to_attachments(workspace, source)
    ref = attachment_ref(source, description, rel_path)
    tag = f"[{user_name}] " if user_name else ""
    line = f"- {tag}{ref}"

    if topic:
        append_to_experience_file(workspace, topic, line)
        commit_memory(
            workspace / "memory", f"attachment: save {source.name} to {topic}"
        )
    else:
        today_str = date.today().isoformat()
        path = ensure_daily_file(workspace, today_str)
        with path.open("a", encoding="utf-8") as f:
            f.write(line + "\n")
        commit_memory(workspace / "memory", f"attachment: save {source.name}")

    return rel_path


def _looks_like_path(text: str) -> bool:
    """Heuristic: does the text look like a file path?"""
    return "/" in text or "\\" in text


def main() -> None:
    parser = argparse.ArgumentParser(
        description="Save text or files to BaoBao's memory"
    )
    parser.add_argument(
        "content",
        help="Text to save, or path to a file (auto-detected)",
    )
    parser.add_argument(
        "description",
        nargs="?",
        default=None,
        help="Description (required for file attachments, ignored for text mode)",
    )
    parser.add_argument("--user", type=str, default=None, help="User name to tag")
    parser.add_argument(
        "-e",
        "--experience",
        type=str,
        default=None,
        metavar="TOPIC",
        help="Save to memory/experience/<topic>.md instead of daily",
    )
    parser.add_argument("--workspace", type=str, default=None, help="Workspace path")
    args = parser.parse_args()

    workspace = Path(args.workspace) if args.workspace else resolve_workspace()
    if not workspace.exists():
        print(f"Workspace not found: {workspace}", file=sys.stderr)
        sys.exit(1)

    source = Path(args.content)
    is_file = source.is_file()

    if is_file:
        # Attachment mode â€” description is required
        if not args.description:
            print(
                "Error: description is required for file attachments", file=sys.stderr
            )
            print(f'Usage: memory-save {args.content} "description"', file=sys.stderr)
            sys.exit(1)

        rel_path = save_attachment(
            workspace, source, args.description, args.user, args.experience
        )
        target = args.experience or "daily"
        print(f"ðŸ’¾ Saved to memory ({target}): {rel_path}")
    else:
        # Text mode â€” warn if content looks like a file path
        text = args.content
        if _looks_like_path(text):
            print(
                f"Warning: '{text}' looks like a file path but file not found, saving as text",
                file=sys.stderr,
            )

        if args.experience:
            rel_path = save_text_experience(workspace, args.experience, text, args.user)
            print(f"ðŸ’¾ Saved to experience: {rel_path}")
        else:
            rel_path = save_text_daily(workspace, text, args.user)
            print(f"ðŸ’¾ Saved to daily: {rel_path}")


if __name__ == "__main__":
    main()
