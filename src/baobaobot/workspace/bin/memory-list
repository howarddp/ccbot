#!/usr/bin/env python3
"""List recent BaoBao daily memories.

Usage:
    memory-list [--days N] [--workspace PATH]

Examples:
    memory-list
    memory-list --days 30
"""

import argparse
import sys
from pathlib import Path

# Allow importing _memory_common from the same directory
sys.path.insert(0, str(Path(__file__).resolve().parent))
from _memory_common import connect_db, list_tags, resolve_workspace, sync_workspace


def main() -> None:
    parser = argparse.ArgumentParser(description="List recent BaoBao memories")
    parser.add_argument(
        "--days", type=int, default=7, help="List last N days (default: 7)"
    )
    parser.add_argument("--workspace", type=str, default=None, help="Workspace path")
    args = parser.parse_args()

    workspace = resolve_workspace(args.workspace)
    if not workspace.exists():
        print(f"Workspace not found: {workspace}", file=sys.stderr)
        sys.exit(1)

    conn = connect_db(workspace)
    sync_workspace(conn, workspace)

    from datetime import date, timedelta

    cutoff = (date.today() - timedelta(days=args.days)).isoformat()

    # List daily memories
    rows = conn.execute(
        "SELECT date, COUNT(*) as line_count FROM memories "
        "WHERE source = 'daily' AND date >= ? GROUP BY date ORDER BY date DESC",
        (cutoff,),
    ).fetchall()

    # List summaries
    summary_rows = conn.execute(
        "SELECT date, COUNT(*) as line_count FROM memories "
        "WHERE source = 'summary' AND date >= ? GROUP BY date ORDER BY date DESC",
        (cutoff,),
    ).fetchall()

    # Stats
    daily_count = conn.execute(
        "SELECT COUNT(DISTINCT date) FROM memories WHERE source = 'daily'"
    ).fetchone()[0]
    total_lines = conn.execute("SELECT COUNT(*) FROM memories").fetchone()[0]
    summary_count = conn.execute(
        "SELECT COUNT(DISTINCT date) FROM memories WHERE source = 'summary'"
    ).fetchone()[0]
    experience_count = conn.execute(
        "SELECT COUNT(DISTINCT date) FROM memories WHERE source = 'experience'"
    ).fetchone()[0]

    if not rows:
        print("No daily memories found.")
    else:
        print("\U0001f4c5 Recent memories:\n")
        for r in rows:
            print(f"  {r['date']}  ({r['line_count']} lines)")

    if summary_rows:
        print("\n\U0001f4cb Recent auto-summaries:\n")
        for r in summary_rows:
            print(f"  {r['date']}  ({r['line_count']} lines)")

    print(
        f"\n\U0001f4ca Total: {daily_count} days, {total_lines} lines indexed, "
        f"{summary_count} summaries"
    )
    if experience_count:
        print(f"   experience/: {experience_count} topic files")

    # Show attachment count
    attachment_count = conn.execute("SELECT COUNT(*) FROM attachment_meta").fetchone()[
        0
    ]
    if attachment_count:
        image_count = conn.execute(
            "SELECT COUNT(*) FROM attachment_meta WHERE file_type = 'image'"
        ).fetchone()[0]
        file_count = attachment_count - image_count
        parts = []
        if image_count:
            parts.append(f"{image_count} images")
        if file_count:
            parts.append(f"{file_count} files")
        print(f"   \U0001f4ce attachments: {', '.join(parts)}")

    # Show tags
    tags = list_tags(conn)
    if tags:
        print(f"\n\U0001f3f7\ufe0f  Tags: {', '.join('#' + t for t in tags)}")

    conn.close()


if __name__ == "__main__":
    main()
