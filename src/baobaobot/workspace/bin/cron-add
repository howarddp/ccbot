#!/usr/bin/env python3
"""Add a cron job to the workspace.

Usage:
    cron-add <schedule> <message> [--name NAME] [--tz TZ] [--workspace PATH]

Schedule formats:
    at:2026-02-28T09:00       One-shot at specific time
    every:30m                 Every 30 minutes (s/m/h/d)
    "0 9 * * *"              Cron expression (5 fields)

Examples:
    cron-add "at:2026-02-28T09:00" "Pick up medicine"
    cron-add "every:1d" "Daily standup reminder" --name daily-standup
    cron-add "0 9 * * 1-5" "Weekly report reminder" --tz Asia/Taipei
"""

import argparse
import sys
from datetime import datetime

from _cron_common import add_job, connect_db, format_ts, parse_schedule, resolve_workspace


def main():
    parser = argparse.ArgumentParser(description="Add a cron job")
    parser.add_argument("schedule", help="Schedule string (at:/every:/cron)")
    parser.add_argument("message", help="Message to send when triggered")
    parser.add_argument("--name", default="", help="Job name (default: auto)")
    parser.add_argument("--tz", default="", help="Timezone (e.g. Asia/Taipei)")
    parser.add_argument("--workspace", default=None, help="Workspace path")
    args = parser.parse_args()

    workspace = resolve_workspace(args.workspace)
    if not workspace.exists():
        print(f"Workspace not found: {workspace}", file=sys.stderr)
        sys.exit(1)

    # Parse schedule
    schedule, err = parse_schedule(args.schedule)
    if schedule is None:
        print(f"Error: {err}", file=sys.stderr)
        sys.exit(1)

    # Apply timezone
    if args.tz and schedule["kind"] == "cron":
        schedule["tz"] = args.tz

    name = args.name or args.message[:30]

    conn = connect_db(workspace)
    try:
        result = add_job(conn, name=name, schedule=schedule, message=args.message, tz=args.tz)
    finally:
        conn.close()

    # Output
    print(f"âœ… Job added: {result['id']}")
    print(f"   Name:     {result['name']}")
    print(f"   Schedule: {args.schedule}")
    print(f"   Message:  {result['message']}")
    next_run = result.get("next_run_at")
    if next_run:
        next_dt = datetime.fromtimestamp(next_run).strftime("%Y-%m-%d %H:%M:%S")
        print(f"   Next run: {next_dt}")
    else:
        print("   Next run: (none / already past)")
    if result.get("delete_after_run"):
        print("   (one-shot, will be deleted after run)")


if __name__ == "__main__":
    main()
