#!/usr/bin/env python3
"""Search BaoBao memories via SQLite index (FTS5 + tag filtering).

Usage:
    memory-search <query> [--days N] [--tag TAG] [--workspace PATH]

Examples:
    memory-search "architecture"
    memory-search "tmux" --days 7
    memory-search "login" --tag decision
"""

import argparse
import sys
from pathlib import Path

# Allow importing _memory_common from the same directory
sys.path.insert(0, str(Path(__file__).resolve().parent))
from _memory_common import (
    connect_db,
    format_file_label,
    resolve_workspace,
    search,
    sync_workspace,
)


def main() -> None:
    parser = argparse.ArgumentParser(description="Search BaoBao memories")
    parser.add_argument("query", help="Search query string")
    parser.add_argument("--days", type=int, default=None, help="Limit to last N days")
    parser.add_argument(
        "--tag", type=str, default=None, help="Filter by tag (without # prefix)"
    )
    parser.add_argument("--workspace", type=str, default=None, help="Workspace path")
    args = parser.parse_args()

    workspace = resolve_workspace(args.workspace)
    if not workspace.exists():
        print(f"Workspace not found: {workspace}", file=sys.stderr)
        sys.exit(1)

    conn = connect_db(workspace)
    sync_workspace(conn, workspace)

    results = search(conn, args.query, args.days, args.tag)

    if not results:
        msg = f"No results for: {args.query}"
        if args.tag:
            msg += f" (tag: #{args.tag})"
        print(msg)
        conn.close()
        sys.exit(0)

    current_file = None
    for r in results:
        file_label = format_file_label(r)
        if file_label != current_file:
            current_file = file_label
            print(f"\n\U0001f4c4 {file_label}")
        print(f"  L{r['line_num']}: {r['content']}")

    # Also search attachment descriptions
    att_results = conn.execute(
        "SELECT memory_path, description, file_path, file_type "
        "FROM attachment_meta WHERE description LIKE ?",
        (f"%{args.query}%",),
    ).fetchall()

    if att_results:
        print(f"\n\U0001f4ce Attachments:")
        for r in att_results:
            icon = "\U0001f5bc" if r["file_type"] == "image" else "\U0001f4c4"
            print(f"  {icon} {r['description']} â†’ {r['file_path']}")
            print(f"     (in {r['memory_path']})")

    total = len(results) + len(att_results)
    suffix = f" [tag: #{args.tag}]" if args.tag else ""
    print(f"\n({total} matches{suffix})")
    conn.close()


if __name__ == "__main__":
    main()
