<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
<title>__TITLE__</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans TC","Hiragino Sans",Roboto,sans-serif;
  background:#fff}

/* ======== DESKTOP: left-right layout ======== */
#map-area{position:absolute;top:0;right:0;bottom:0;left:380px}
#panel{position:absolute;top:0;left:0;bottom:0;width:380px;
  overflow-y:auto;overflow-x:hidden;background:#fff;
  border-right:1px solid #e2e8f0;z-index:500;
  transition:transform .3s ease;
  -webkit-overflow-scrolling:touch}
#panel.collapsed{transform:translateX(-100%)}
#panel.collapsed ~ #map-area{left:0}

/* ======== MOBILE ======== */
@media(max-width:768px){
  #map-area{position:absolute;top:0;left:0;right:0;bottom:0}
  #panel{position:absolute;top:auto;left:0;right:0;width:100%;
    bottom:0;max-height:55%;border-right:none;
    border-top:2px solid #e2e8f0;border-radius:16px 16px 0 0;
    box-shadow:0 -4px 20px rgba(0,0,0,.1);
    transition:transform .3s ease}
  #panel.collapsed{transform:translateY(100%)}
  #panel.collapsed ~ #map-area{bottom:0}
}

/* ======== Toggle Button ======== */
.toggle{
  position:fixed;top:12px;left:12px;z-index:9999;
  background:#fff;border:none;border-radius:10px;
  padding:10px 16px;cursor:pointer;font-size:14px;
  box-shadow:0 2px 10px rgba(0,0,0,.15);
  display:flex;align-items:center;gap:6px;
  font-weight:600;color:#2d3748;
  -webkit-tap-highlight-color:transparent}
.toggle:active{background:#f0f0f0}
@media(max-width:768px){.toggle{top:10px;left:10px}}

/* ======== Panel Content ======== */
.handle{width:40px;height:5px;border-radius:3px;background:#cbd5e0;margin:10px auto 6px;display:none}
@media(max-width:768px){.handle{display:block}}

.panel-header{
  position:sticky;top:0;z-index:10;
  padding:16px 20px;background:#f7fafc;
  border-bottom:1px solid #e2e8f0;
  border-left:5px solid #4285F4}
.panel-header h1{font-size:17px;color:#1a202c;font-weight:700;line-height:1.3}
.panel-header .subtitle{font-size:12px;color:#718096;margin-top:3px}

.place{display:flex;align-items:center;gap:12px;padding:12px 18px;
  -webkit-tap-highlight-color:transparent;cursor:pointer}
.place:active{background:#f0f4f8}
.marker{width:32px;height:32px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  color:#fff;font-weight:700;font-size:14px;flex-shrink:0;
  box-shadow:0 2px 4px rgba(0,0,0,.15)}
.place-info{flex:1;min-width:0}
.place-name{font-size:15px;color:#2d3748;font-weight:600}
.place-sub{font-size:11px;color:#a0aec0;margin-top:1px}

.leg{display:flex;align-items:center;gap:8px;
  padding:4px 18px 4px 35px;margin-left:16px;
  border-left:2px dashed #cbd5e0}
.badge{display:inline-flex;padding:2px 10px;border-radius:10px;
  color:#fff;font-size:11px;font-weight:600;white-space:nowrap}
.leg-text{color:#718096;font-size:12px;white-space:nowrap}

/* ======== Day Tabs (multi-day mode) ======== */
.day-tabs{
  display:flex;gap:0;border-bottom:2px solid #e2e8f0;
  background:#f7fafc;position:sticky;top:0;z-index:11;
  overflow-x:auto;-webkit-overflow-scrolling:touch}
.day-tab{
  flex:1;min-width:0;padding:12px 8px;text-align:center;
  font-size:13px;font-weight:600;color:#718096;
  cursor:pointer;border-bottom:3px solid transparent;
  transition:all .2s;white-space:nowrap;
  -webkit-tap-highlight-color:transparent;background:none;border-top:none;border-left:none;border-right:none}
.day-tab:hover{color:#2d3748;background:#edf2f7}
.day-tab.active{color:#4285F4;border-bottom-color:#4285F4;background:#fff}
.day-content{display:none}
.day-content.active{display:block}

/* ======== Map Legend ======== */
.map-legend{
  position:absolute;bottom:20px;right:10px;z-index:800;
  background:rgba(255,255,255,.92);border-radius:8px;
  padding:8px 12px;font-size:11px;color:#4a5568;
  box-shadow:0 2px 8px rgba(0,0,0,.1);
  backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}
.map-legend .li{display:flex;align-items:center;gap:5px;margin:2px 0}
.map-legend .ll{width:20px;height:3px;border-radius:2px;flex-shrink:0}

/* ======== Leaflet overrides ======== */
.leaflet-popup-content{font-family:inherit;font-size:14px;line-height:1.4}
.leaflet-popup-content b{color:#2d3748}
#map{width:100%;height:100%}
.panel::-webkit-scrollbar{width:3px}
.panel::-webkit-scrollbar-thumb{background:#cbd5e0;border-radius:2px}

/* ======== Print mode: ?print=1 ======== */
body.print-mode{overflow:visible;height:auto!important}
body.print-mode #panel{display:none}
body.print-mode .toggle{display:none}
body.print-mode #map-area{position:relative;left:0;top:0;right:0;bottom:auto;
  width:100%;height:600px}
body.print-mode .map-legend{bottom:10px;right:10px}
body.print-mode .leaflet-control-zoom{display:none}
</style>
</head>
<body>

<button class="toggle" id="toggleBtn" onclick="togglePanel()">
  <span id="toggleIcon">☰</span>
  <span>路線</span>
</button>
<div id="panel"></div>
<div id="map-area">
  <div id="map"></div>
  <div class="map-legend" id="mapLegend"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
// ============================================================
// ROUTE DATA — injected by Python script
// ============================================================
const ROUTE_DATA = __ROUTE_DATA_JSON__;

// ============================================================
// Config
// ============================================================
const MC={green:'#34A853',blue:'#4285F4',red:'#EA4335'};
const TC={
  '步行':'#38A169','電車':'#D69E2E','公車':'#3182CE',
  '地鐵':'#805AD5','計程車':'#E53E3E','自駕':'#DD6B20',
  'Walk':'#38A169','Train':'#D69E2E','Bus':'#3182CE',
  'Subway':'#805AD5','Taxi':'#E53E3E','Drive':'#DD6B20'
};
const TD={'步行':[6,8],'Walk':[6,8]};
const DAY_COLORS=['#EA4335','#4285F4','#34A853','#FBBC04','#9C27B0','#FF6D00','#00BCD4'];

// ============================================================
// Detect mode
// ============================================================
const IS_MULTI=ROUTE_DATA.mode==='multi'&&Array.isArray(ROUTE_DATA.days);

// ============================================================
// Decode Google encoded polyline
// ============================================================
function decodePoly(s){
  let i=0,lat=0,lng=0;const c=[];
  while(i<s.length){
    let b,sh=0,r=0;
    do{b=s.charCodeAt(i++)-63;r|=(b&0x1f)<<sh;sh+=5}while(b>=0x20);
    lat+=(r&1)?~(r>>1):(r>>1);sh=0;r=0;
    do{b=s.charCodeAt(i++)-63;r|=(b&0x1f)<<sh;sh+=5}while(b>=0x20);
    lng+=(r&1)?~(r>>1):(r>>1);c.push([lat/1e5,lng/1e5]);
  }
  return c;
}

// ============================================================
// Build single-day panel content
// ============================================================
function buildDayHTML(data,dayIndex){
  let h='';
  const places=data.places||[], legs=data.legs||[];
  places.forEach((p,i)=>{
    const lb=String.fromCharCode(65+i);
    const cl=MC[p.color]||'#4285F4';
    const globalIdx=dayIndex!==undefined?`${dayIndex},${i}`:String(i);
    const sf=i===0?'<div class="place-sub">起點</div>':
             i===places.length-1?'<div class="place-sub">終點</div>':'';
    h+=`<div class="place" onclick="focusMarker(${globalIdx})">
      <div class="marker" style="background:${cl}">${lb}</div>
      <div class="place-info"><div class="place-name">${p.name}</div>${sf}</div></div>`;
    if(i<legs.length){
      const l=legs[i],bc=TC[l.transport]||'#718096';
      h+=`<div class="leg"><span class="badge" style="background:${bc}">${l.transport}</span>
        <span class="leg-text">${l.duration} · ${l.distance}</span></div>`;
    }
  });
  return h;
}

// ============================================================
// Build panel (single or multi)
// ============================================================
function buildPanel(){
  const el=document.getElementById('panel');
  let h='<div class="handle"></div>';

  if(!IS_MULTI){
    const {title,subtitle}=ROUTE_DATA;
    h+=`<div class="panel-header"><h1>${title}</h1>`;
    if(subtitle) h+=`<div class="subtitle">${subtitle}</div>`;
    h+=`</div>`;
    h+=buildDayHTML(ROUTE_DATA);
  } else {
    const {title,subtitle,days}=ROUTE_DATA;
    h+=`<div class="panel-header"><h1>${title}</h1>`;
    if(subtitle) h+=`<div class="subtitle">${subtitle}</div>`;
    h+=`</div>`;
    // Day tabs
    h+='<div class="day-tabs">';
    h+=`<button class="day-tab active" onclick="switchDay(-1)">總覽</button>`;
    days.forEach((d,i)=>{
      const label=d.tab||d.title||('Day '+(i+1));
      h+=`<button class="day-tab" onclick="switchDay(${i})">${label}</button>`;
    });
    h+='</div>';
    // Overview content (shown by default)
    h+=`<div class="day-content active" id="day-overview">`;
    days.forEach((d,i)=>{
      const dc=DAY_COLORS[i%DAY_COLORS.length];
      h+=`<div style="padding:10px 18px 4px;font-size:13px;font-weight:700;color:${dc};
        border-left:4px solid ${dc};margin:8px 12px 0">${d.title||'Day '+(i+1)}</div>`;
      h+=buildDayHTML(d,i);
    });
    h+=`</div>`;
    // Per-day content (hidden by default)
    days.forEach((d,i)=>{
      h+=`<div class="day-content" id="day-${i}">`;
      h+=buildDayHTML(d,i);
      h+=`</div>`;
    });
  }
  el.innerHTML=h;
}

// ============================================================
// Build map legend
// ============================================================
function buildLegend(legs){
  const seen=new Set();
  let h='';
  (legs||[]).forEach(l=>{
    if(seen.has(l.transport))return;seen.add(l.transport);
    const c=TC[l.transport]||'#718096';
    const st=TD[l.transport]?`border-top:3px dashed ${c};height:0`:`background:${c}`;
    h+=`<div class="li"><span class="ll" style="${st}"></span>${l.transport}</div>`;
  });
  const el=document.getElementById('mapLegend');
  el.innerHTML=h;if(!h)el.style.display='none';else el.style.display='';
}

// ============================================================
// Build map
// ============================================================
let map;
let allLayers=[];   // {dayIndex, layer, type:'marker'|'route'}
let markersByDay={}; // dayIndex -> [markers]

function addDayToMap(data,dayIndex,bounds){
  const places=data.places||[], legs=data.legs||[];
  const dayMarkers=[];

  places.forEach((p,i)=>{
    const lb=String.fromCharCode(65+i);
    const cl=MC[p.color]||'#4285F4';
    const icon=L.divIcon({className:'',
      html:`<div style="width:30px;height:30px;border-radius:50%;background:${cl};
        color:#fff;font-weight:700;font-size:13px;display:flex;align-items:center;
        justify-content:center;box-shadow:0 2px 6px rgba(0,0,0,.3);
        border:2px solid #fff">${lb}</div>`,
      iconSize:[30,30],iconAnchor:[15,15],popupAnchor:[0,-16]});
    const m=L.marker([p.lat,p.lng],{icon}).addTo(map);
    const dayLabel=dayIndex>=0?(ROUTE_DATA.days[dayIndex].title||'Day '+(dayIndex+1))+' — ':'';
    const sf=i===0?' (起點)':i===places.length-1?' (終點)':'';
    m.bindPopup(`<b>${dayLabel}${lb}. ${p.name}${sf}</b>`);
    dayMarkers.push(m);
    allLayers.push({dayIndex,layer:m,type:'marker'});
    bounds.extend([p.lat,p.lng]);
  });

  legs.forEach((leg,i)=>{
    let coords;
    if(leg.polyline) coords=decodePoly(leg.polyline);
    else{const a=places[i],b=places[i+1];if(a&&b)coords=[[a.lat,a.lng],[b.lat,b.lng]];}
    if(coords&&coords.length){
      const c=TC[leg.transport]||'#4285F4';
      const d=TD[leg.transport]||null;
      const o={color:c,weight:5,opacity:.8};if(d)o.dashArray=d.join(' ');
      const line=L.polyline(coords,o).addTo(map).bindPopup(`${leg.transport} ${leg.duration} / ${leg.distance}`);
      allLayers.push({dayIndex,layer:line,type:'route'});
      coords.forEach(c=>bounds.extend(c));
    }
  });

  markersByDay[dayIndex]=dayMarkers;
}

function buildMap(){
  map=L.map('map',{zoomControl:true,attributionControl:true,tap:true});
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'© OpenStreetMap',maxZoom:19
  }).addTo(map);

  const bounds=L.latLngBounds();

  if(!IS_MULTI){
    addDayToMap(ROUTE_DATA,-1,bounds);
    buildLegend(ROUTE_DATA.legs);
  } else {
    ROUTE_DATA.days.forEach((d,i)=>addDayToMap(d,i,bounds));
    // Build combined legend
    const allLegs=[];
    ROUTE_DATA.days.forEach(d=>(d.legs||[]).forEach(l=>allLegs.push(l)));
    buildLegend(allLegs);
  }

  if(!allLayers.length&&ROUTE_DATA.polyline){
    const c=decodePoly(ROUTE_DATA.polyline);
    L.polyline(c,{color:'#4285F4',weight:5,opacity:.8}).addTo(map);
    c.forEach(p=>bounds.extend(p));
  }

  if(bounds.isValid()) map.fitBounds(bounds,{padding:[50,50]});
  setTimeout(()=>map.invalidateSize(),100);
  setTimeout(()=>map.invalidateSize(),500);
}

// ============================================================
// Multi-day: switch day tab
// ============================================================
let currentDay=-1; // -1 = overview (all days)

function switchDay(dayIdx){
  if(!IS_MULTI)return;
  currentDay=dayIdx;

  // Update tabs
  document.querySelectorAll('.day-tab').forEach((t,i)=>{
    t.classList.toggle('active',i===(dayIdx+1));
  });

  // Update panel content
  document.querySelectorAll('.day-content').forEach(el=>el.classList.remove('active'));
  if(dayIdx===-1){
    document.getElementById('day-overview').classList.add('active');
  } else {
    const el=document.getElementById('day-'+dayIdx);
    if(el) el.classList.add('active');
  }

  // Update map layers
  const bounds=L.latLngBounds();
  allLayers.forEach(({dayIndex,layer})=>{
    if(dayIdx===-1||dayIndex===dayIdx){
      if(!map.hasLayer(layer)) layer.addTo(map);
      if(layer.getLatLng) bounds.extend(layer.getLatLng());
      else if(layer.getBounds) bounds.extend(layer.getBounds());
    } else {
      if(map.hasLayer(layer)) map.removeLayer(layer);
    }
  });
  if(bounds.isValid()) map.fitBounds(bounds,{padding:[50,50]});

  // Update legend
  if(dayIdx===-1){
    const allLegs=[];
    ROUTE_DATA.days.forEach(d=>(d.legs||[]).forEach(l=>allLegs.push(l)));
    buildLegend(allLegs);
  } else {
    buildLegend(ROUTE_DATA.days[dayIdx].legs);
  }
}

// ============================================================
// Toggle & focus
// ============================================================
let panelOpen=true;
function togglePanel(){
  panelOpen=!panelOpen;
  document.getElementById('panel').classList.toggle('collapsed');
  var btn=document.getElementById('toggleBtn');
  var mapArea=document.getElementById('map-area');
  if(window.innerWidth>768){
    btn.style.left=panelOpen?'392px':'12px';
    mapArea.style.left=panelOpen?'380px':'0';
  }
  setTimeout(()=>map&&map.invalidateSize(),350);
}
function focusMarker(dayIdx,placeIdx){
  // Support both focusMarker(i) for single mode and focusMarker(dayIdx,placeIdx) for multi
  if(placeIdx===undefined){placeIdx=dayIdx;dayIdx=-1;}
  const ms=markersByDay[dayIdx];
  if(!ms||!ms[placeIdx])return;
  const data=dayIdx>=0?ROUTE_DATA.days[dayIdx]:ROUTE_DATA;
  const p=(data.places||[])[placeIdx];
  if(!p)return;
  map.setView([p.lat,p.lng],16,{animate:true});
  ms[placeIdx].openPopup();
  if(window.innerWidth<=768&&panelOpen){togglePanel();}
}

// ============================================================
// Layout sizing (fixes in-app browser vh issues)
// ============================================================
function fixLayout(){
  const h=window.innerHeight;
  document.body.style.height=h+'px';
  const mapArea=document.getElementById('map-area');
  if(window.innerWidth<=768){
    mapArea.style.top='0';mapArea.style.left='0';
    mapArea.style.right='0';mapArea.style.bottom='0';
    mapArea.style.height=h+'px';
  } else {
    mapArea.style.height=h+'px';
  }
  if(map)map.invalidateSize();
}

// ============================================================
// Print mode detection (?print=1)
// ============================================================
const PRINT_MODE=new URLSearchParams(window.location.search).has('print');

// ============================================================
// Init
// ============================================================
document.addEventListener('DOMContentLoaded',()=>{
  if(PRINT_MODE){
    document.body.classList.add('print-mode');
    buildMap();
    setTimeout(()=>{
      if(map)map.invalidateSize();
      const ready=document.createElement('div');
      ready.id='print-ready';
      ready.style.display='none';
      document.body.appendChild(ready);
    },2000);
    return;
  }
  fixLayout();
  buildPanel();
  buildMap();
  if(window.innerWidth>768){
    document.getElementById('toggleBtn').style.left='392px';
  }
});
window.addEventListener('resize',fixLayout);
window.addEventListener('orientationchange',()=>setTimeout(fixLayout,200));
</script>
</body>
</html>
