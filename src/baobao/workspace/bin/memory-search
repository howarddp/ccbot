#!/usr/bin/env python3
"""Search BaoBao memories via SQLite index.

Usage:
    memory-search <query> [--days N] [--workspace PATH]

Examples:
    memory-search "æž¶æ§‹"
    memory-search "tmux" --days 7
    memory-search "bug" --workspace ~/.baobao/workspace
"""

import argparse
import os
import sys
from pathlib import Path


def resolve_workspace() -> Path:
    """Resolve workspace directory from env or default."""
    raw = os.environ.get("WORKSPACE_DIR", "")
    if raw:
        return Path(raw).expanduser()
    baobao_dir = os.environ.get("BAOBAO_DIR", "")
    if baobao_dir:
        return Path(baobao_dir) / "workspace"
    return Path.home() / ".baobao" / "workspace"


def main() -> None:
    parser = argparse.ArgumentParser(description="Search BaoBao memories")
    parser.add_argument("query", help="Search query string")
    parser.add_argument("--days", type=int, default=None, help="Limit to last N days")
    parser.add_argument("--workspace", type=str, default=None, help="Workspace path")
    args = parser.parse_args()

    workspace = Path(args.workspace) if args.workspace else resolve_workspace()

    if not workspace.exists():
        print(f"Workspace not found: {workspace}", file=sys.stderr)
        sys.exit(1)

    # Import inline to keep startup fast â€” only needs sqlite3 + pathlib
    sys.path.insert(0, str(Path(__file__).resolve().parents[3]))
    from baobao.memory.db import MemoryDB

    db = MemoryDB(workspace)
    results = db.search(args.query, days=args.days)

    if not results:
        print(f"No results for: {args.query}")
        sys.exit(0)

    current_file = None
    for row in results:
        if row["source"] == "memory_md":
            file_label = "MEMORY.md"
        else:
            file_label = f"memory/{row['date']}.md"

        if file_label != current_file:
            current_file = file_label
            print(f"\nðŸ“„ {file_label}")

        print(f"  L{row['line_num']}: {row['content']}")

    print(f"\n({len(results)} matches)")
    db.close()


if __name__ == "__main__":
    main()
